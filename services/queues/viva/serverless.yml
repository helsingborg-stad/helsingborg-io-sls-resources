service: queues-viva

custom: ${file(../../../serverless.common.yml):custom}

provider:
  name: aws
  stage: dev
  region: eu-north-1

resources:
  Resources:
    VivaSubmissionDeadLetterQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.resourcesStage}-VivaSubmissionDeadLetterQueue
        MessageRetentionPeriod: 1209600  # 14 days
        RedriveAllowPolicy: 
          redrivePermission: byQueue
          sourceQueueArns:
            - !Sub arn:aws:sqs:${self:provider.region}:${AWS::AccountId}:${self:custom.stage}-VivaSubmissionQueue

    VivaSubmissionToVivaDeadLetterQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: sqs.amazonaws.com
              Action: SQS:SendMessage
              Resource: !Sub arn:aws:sqs:${self:provider.region}:${AWS::AccountId}:${self:custom.stage}-VivaSubmissionQueue
        Queues:
          - !Ref VivaSubmissionDeadLetterQueue

    VivaSubmissionQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:custom.resourcesStage}-VivaSubmissionQueue
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt VivaSubmissionDeadLetterQueue.Arn
          maxReceiveCount: 10
        VisibilityTimeout: 120

    EventBridgeToVivaQueuePolicy:
      Type: AWS::SQS::QueuePolicy
      Properties:
        PolicyDocument:
          Statement:
            - Effect: Allow
              Principal:
                Service: events.amazonaws.com
              Action: SQS:SendMessage
              Resource: !GetAtt VivaSubmissionQueue.Arn
        Queues:
          - Ref: VivaSubmissionQueue

    PostToVivaQueue:
      Type: "AWS::Events::Rule"
      Properties:
        Targets:
          - Arn: !GetAtt VivaSubmissionQueue.Arn
            Id: "VivaSubmissionQueue"
        EventPattern:
          source:
            - cases.database
          detail-type:
            - MODIFY
          detail:
            dynamodb:
              NewImage:
                provider:
                  S: ["VIVA"]
                status:
                  M:
                    type:
                      S: [{ "prefix": "active:submitted" }]
                state:
                  S: ["PDF_GENERATED"]

  Outputs:
    VivaSubmissionQueueArn:
      Value: !GetAtt VivaSubmissionQueue.Arn
      Export:
        Name: ${self:custom.stage}-VivaSubmissionQueueArn
